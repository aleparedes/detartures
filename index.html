<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Abfahrten – Bus Matrix</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@800;900&display=swap" rel="stylesheet">

<style>
  /* --- ANIMATION FÜR SUBTILES LED-FLACKERN --- */
  @keyframes subtle-flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.98; } 
      70% { opacity: 0.99; }
  }

  :root {
    --frame-bg: #e7e9ed;
    --frame-border: #c3c7cd;
    --header-text: #111;
    --bvg-yellow: #ffd200;
    --muted: #4a4f57;
    --led-bg: #070707;
    --led-glow-color: #ffc23a;
    --led-alert-color: #ff6666; /* Farbe für Alarm (sofortige Abfahrt) */
    --font-weight-header: 800;
    --font-weight-regular: 900;
  }
  html, body {
    height: 100%;
    margin: 0;
    background: #dfe2e6;
    /* 💡 Tipografía: Usamos Inter para simular FF Transit, con respaldos */
    font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    color: var(--header-text);
  }
  .board {
    position: fixed;
    inset: 0;
    display: grid;
    grid-template-rows: 42px 1fr 44px;
    background: var(--frame-bg);
    border: 8px solid var(--frame-border);
    border-radius: 6px;
    box-shadow: 0 12px 30px rgba(0,0,0,.25), inset 0 -10px 0 rgba(255,255,255,.6);
  }
  .header {
    /* Grid: 170px para Linie, 1fr para Ziel, y AHORA 180px para Abfahrt in */
    display: grid;
    grid-template-columns: 170px 1fr 180px; 
    align-items: center;
    font-weight: var(--font-weight-header);
    padding: 6px 10px 4px 10px;
    font-size: clamp(14px, 2.2vw, 22px);
  }
  .header .left   { justify-self: start; padding-left: 12px; }
  .header .center { justify-self: start; } 
  .header .right  { justify-self: end; padding-right: 0; }
  .led {
    margin: 0 10px 8px 10px;
    background: var(--led-bg);
    border: 2px solid #111;
    border-radius: 2px;
    padding: 2px 0 2px 8px; 
    display: grid;
    grid-auto-rows: 1fr;
    position: relative;
    overflow: hidden;

    animation: subtle-flicker 4s infinite alternate; 
  }
  .led::before{
    content: "";
    position: absolute;
    inset: 0;
    background-image: radial-gradient(rgba(255,255,255,0.022) 1px, transparent 1.1px);
    background-size: 6px 6px;
    mix-blend-mode: screen;
    pointer-events: none;
  }
  .row {
    /* Las filas de datos usan el mismo grid: 170px 1fr 180px */
    display: grid;
    grid-template-columns: 170px 1fr 180px; 
    align-items: center;
    padding: 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    white-space: nowrap;
    column-gap: 2px;
  }
  .row:last-child { border-bottom: 0; }
  .col-line { padding-left: 4px; display: flex; align-items: center; gap: 2px; } 
  .badge { 
    width: 120px;
    border-radius: 4px;
    background: linear-gradient(#0f0f0f,#0a0a0a);
    border: 1px solid #3a3a3a;
    box-shadow: 0 0 0 1px #1e1e1e inset, 0 2px 0 rgba(255,255,255,0.05) inset;
    display: grid; place-items: center;
  }
  .col-dest { overflow: hidden; }
  .col-eta  {
    justify-self: end;
    padding-right: 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  /* Estilo para ETA 0-1 min (¡Saliendo ya!) */
  .col-eta.alert .svg-text {
    color: var(--led-alert-color) !important;
  }
  .footer {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 10px;
    padding: 6px 10px 8px 10px;
  }
  .station {
    background: #fff;
    border-top-right-radius: 4px;
    border-bottom-right-radius: 4px;
    padding: 6px 10px;
    font-weight: var(--font-weight-header);
    font-size: clamp(13px, 1.8vw, 18px);
    color: #222;
    max-width: 60vw;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .bvg-tag { justify-self: end; display: inline-flex; align-items: center; gap: 10px; font-size: clamp(12px, 1.8vw, 16px); color: var(--muted); }
  .bvg-box { background: var(--bvg-yellow); color: #111; font-weight: 1000; padding: 2px 6px; border-radius: 2px; border: 1px solid #b79b00; }
  .age { padding: 2px 10px; border-radius: 999px; background: #fff; border: 1px solid #cfd3d8; transition: background-color 0.5s; }
  .loading { background-color: var(--bvg-yellow) !important; }
  .error-state { background-color: var(--led-alert-color) !important; color: #fff !important; }

  /* Estilo para mensajes de error y carga en la matriz */
  .led-message {
    height: 100%;
    display: grid;
    place-items: center;
    font-size: clamp(16px, 4vw, 30px);
    font-weight: 900;
    color: #fff;
    text-align: center;
    white-space: normal;
  }
  * { box-sizing: border-box; }
  ::-webkit-scrollbar { display: none; }
</style>
</head>
<body>
  <div class="board">
    <div class="header">
      <div class="left">Linie</div>
      <div class="center">Ziel</div> 
      <div class="right">Abfahrt in</div> 
    </div>
    <div class="led" id="led">
      <div class="led-message">Lade Daten...</div>
    </div>
    <div class="footer">
      <div class="station" id="stationLabel">Haltestelle wird gesucht...</div>
      <div class="bvg-tag">
        <span class="age" id="age">Aktualisiere...</span>
        <span class="bvg-box">BVG</span>
      </div>
    </div>
  </div>

<script>
// --- CONFIGURACIÓN (Español/Inglés) ---
const cfg = {
  // 🚨 HIER BITTE DEINEN HALTESTELLENNAMEN EINGEBEN (REQUIRED) 🚨
  stopQuery: "Rotkopfweg", 
  maxRows: 5,
  dotBaselineRows: 6, 
  lookAheadMinutes: 60,
  refreshMs: 30_000,
  textBoost: 1.21,
  ledScale: 0.7,
  attenuateGlow: 0.9,
  cacheKey: 'bus_departures_cache',
};

const API_URLS = [
  "https://v6.bvg.transport.rest",
  "https://v6.vbb.transport.rest"
];

const el = {
  led: document.getElementById('led'),
  age: document.getElementById('age'),
  station: document.getElementById('stationLabel')
};

// --- TIME AND STATUS UTILITIES (Visible text in German) ---
let lastRefreshTs = Date.now();
let isLoading = false;

function tickAge(){
  if(isLoading) {
    el.age.textContent = `Aktualisiere...`;
    el.age.classList.add('loading');
    return;
  }
  const s = Math.max(0, Math.round((Date.now() - lastRefreshTs) / 1000));
  // "Aktualisiert vor X s"
  el.age.textContent = `Aktualisiert vor ${s}s`; 
  el.age.classList.remove('loading');
  el.age.classList.remove('error-state');
}
tickAge();
setInterval(tickAge, 1000);

function minutesUntil(t){ return Math.max(0, Math.round((new Date(t).getTime() - Date.now())/60000)); }

// --- TEXT MEASUREMENT UTILITIES (Español/Inglés) ---
const measureCtx = document.createElement('canvas').getContext('2d');
function widthFor(text, fs, weight='900'){
  // 💡 Usamos 'Inter' aquí también para medir el truncamiento
  measureCtx.font = `${weight} ${fs}px Inter, Segoe UI, Roboto, Arial`;
  return measureCtx.measureText(text).width;
}
function fitFontSizeHeightOnly(maxHeight, factor=0.78){
  return Math.max(10, Math.floor(maxHeight * factor));
}
function truncateHard(text, fs, maxWidth){
  // Cut without ellipsis to simulate LED matrix
  if (widthFor(text, fs) <= maxWidth) return text;
  let low = 0, high = text.length;
  while (low < high){
    const mid = Math.floor((low + high) / 2);
    const t = text.slice(0, mid);
    if (widthFor(t, fs) <= maxWidth) low = mid + 1;
    else high = mid;
  }
  const cut = Math.max(0, low - 1);
  return text.slice(0, cut);
}

// --- LED SVG FUNCTION (Español/Inglés) ---
function ledSVG(text, w, h, fs, opts={}){
  const basePitch = Math.max(4, Math.floor(h/10));
  const pitch = Math.max(3, Math.floor(basePitch * cfg.ledScale));
  const r = Math.max(2, Math.floor(pitch * 0.40));
  const pad = Math.floor(pitch * 0.85);
  const glow = Math.max(0.4, Math.min(1.0, cfg.attenuateGlow || 1));
  const fsBoost = Math.floor(fs * cfg.textBoost);
  const safe = String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const id = 'p'+Math.random().toString(36).slice(2,8);
  const clipW = Math.max(10, (opts.clipWidth ?? (w - pad*2)));
  const align = opts.align || 'left';
  const x = align === 'right' ? (w - pad) : pad;
  const textAnchor = align === 'right' ? 'end' : 'start';
  const y = h*0.72;
  
  const glowColor = opts.isAlert ? 'var(--led-alert-color)' : 'var(--led-glow-color)';
  const hotColor = opts.isAlert ? '#fff9d6' : '#ffe6a3'; 

  return `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}" width="${w}" height="${h}" preserveAspectRatio="xMidYMid meet" style="display:block">
    <defs>
      <pattern id="${id}-dots" patternUnits="userSpaceOnUse" width="${pitch}" height="${pitch}">
        <radialGradient id="${id}-g" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="${hotColor}"/>
          <stop offset="55%" stop-color="${glowColor}"/>
          <stop offset="100%" stop-color="#563800"/>
        </radialGradient>
        <circle cx="${r}" cy="${r}" r="${r}" fill="url(#${id}-g)"/>
      </pattern>
      <filter id="${id}-dilate">
        <feMorphology operator="dilate" radius="${Math.max(0, Math.floor(r*0.28))}"/>
      </filter>
      <filter id="${id}-glow" x="-12%" y="-12%" width="124%" height="124%">
        <feGaussianBlur stdDeviation="${Math.max(0.4, r*0.28)}" result="b"/>
        <feComponentTransfer>
          <feFuncA type="linear" slope="${glow}"/>
        </feComponentTransfer>
          <feMerge>
          <feMergeNode in="b"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
      <clipPath id="${id}-clip"><rect x="${align==='right' ? (w-clipW-pad) : 0}" y="0" width="${clipW}" height="${h}"/></clipPath>
      <mask id="${id}-mask">
        <rect width="100%" height="100%" fill="black"/>
        <g filter="url(#${id}-dilate)" clip-path="url(#${id}-clip)">
          <text class="svg-text" x="${x}" y="${y}" text-anchor="${textAnchor}" font-family="'Inter', Segoe UI, Roboto, Arial" font-weight="${opts.isAlert ? 1000 : 900}" font-size="${fsBoost}" fill="white"
                letter-spacing="-0.01em">${safe}</text>
        </g>
      </mask>
    </defs>
    <rect width="100%" height="100%" fill="url(#${id}-dots)" mask="url(#${id}-mask)" filter="url(#${id}-glow)"/>
  </svg>`;
}

// --- API AND DATA LOGIC (Español/Inglés) ---
async function findStops(name, apiBase){
  if (!name) throw new Error("Stop query is empty.");
  const url = `${apiBase}/locations?query=${encodeURIComponent(name)}&results=10&stops=true&addresses=false&poi=false&pretty=false`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error(`findStops ${apiBase}: ${res.status}`);
  const arr = await res.json();
  return arr.filter(x=>x.type==="stop").slice(0,2).map(s=>({id:s.id,name:s.name}));
}

async function fetchDepartures(stopId, apiBase){
  const params = new URLSearchParams({duration:String(cfg.lookAheadMinutes),remarks:'false',includeRelatedStations:'true',pretty:'false'});
  const url = `${apiBase}/stops/${encodeURIComponent(stopId)}/departures?`+params.toString();
  const res = await fetch(url,{cache:"no-store"});
  if(!res.ok) throw new Error(`departures ${apiBase} ${stopId}: ${res.status}`);
  const data = await res.json();
  return Array.isArray(data)?data:(data.departures||[]);
}

function normalize(dep){
  return {
    when: dep.when || dep.plannedWhen,
    line: dep.line?.name || dep.line?.id || '',
    product: dep.line?.product || dep.line?.mode || '',
    direction: dep.direction || dep.destination?.name || dep.directionId || '—',
    cancelled: !!dep.cancelled
  };
}

function pickRows(deps){
  return deps.map(normalize)
    .filter(d => (d.product || '').toLowerCase()==='bus' && !d.cancelled && !!d.when)
    .sort((a,b)=> new Date(a.when) - new Date(b.when))
    .slice(0, cfg.maxRows);
}

async function loadData(){
  if (!cfg.stopQuery) {
    // Error message in German (rendered)
    throw new Error("❌ FEHLER: Haltestellenabfrage fehlt. Bitte 'stopQuery' Variable prüfen.");
  }
  
  for (const apiBase of API_URLS) {
    try {
      const stops = await findStops(cfg.stopQuery, apiBase);
      if(stops.length) el.station.textContent = stops[0].name || cfg.stopQuery;
      
      const all = await Promise.allSettled(stops.map(s=>fetchDepartures(s.id, apiBase)));
      const deps = all.filter(x=>x.status==='fulfilled').flatMap(x=>x.value);
      
      if (deps.length > 0) {
        localStorage.setItem(cfg.cacheKey, JSON.stringify({ data: deps, timestamp: Date.now() }));
        return deps;
      }
    } catch (e) {
      console.warn(`Fallo en API ${apiBase}:`, e);
    }
  }
  // Error message in German (rendered)
  throw new Error("Alle Datenquellen sind fehlgeschlagen.");
}

function loadCache(){
  try {
    const cached = localStorage.getItem(cfg.cacheKey);
    if (cached) {
      const { data, timestamp } = JSON.parse(cached);
      lastRefreshTs = timestamp;
      return data;
    }
  } catch (e) {
    console.error("Error al cargar el caché:", e);
    localStorage.removeItem(cfg.cacheKey);
  }
  return null;
}

// --- RENDERING TO DOM (Español/Inglés) ---
function createRow(it, dotH, fsBase, destW, lineW_Col, ETA_WIDTH, UNIT_WIDTH) {
  const r = document.createElement('div');
  r.className = 'row';

  // Column 1: Line 
  const c1 = document.createElement('div'); c1.className='col-line';
  const code = (it.line||'').replace(/[^A-Za-z0-9]/g,'').slice(0,4) || '—';
  c1.innerHTML = ledSVG(code, lineW_Col-8, dotH, fsBase, {clipWidth: lineW_Col-8, align:'left'}); 
  c1.style.width = lineW_Col + 'px'; 
  r.appendChild(c1);

  // Column 2: Destination (Ziel)
  const c2 = document.createElement('div'); c2.className='col-dest';
  const cut = truncateHard(it.direction, Math.floor(fsBase*cfg.textBoost), destW-2); 
  c2.innerHTML = ledSVG(cut, destW, dotH, fsBase, {clipWidth: destW-2, align:'left'}); 
  r.appendChild(c2);

  // Column 3: ETA
  const c3 = document.createElement('div'); c3.className='col-eta';
  
  const min = minutesUntil(it.when);
  const isAlert = min <= 1; 
  if (isAlert) c3.classList.add('alert');

  // Ajuste de los anchos para [X] Min
  const NUM_WIDTH = ETA_WIDTH - UNIT_WIDTH - 6; 

  // 1. Número de minutos
  const num = document.createElement('div');
  num.innerHTML = ledSVG(String(min), NUM_WIDTH, dotH, fsBase, {clipWidth: NUM_WIDTH-2, align:'right', isAlert});
  c3.appendChild(num);
  
  // 2. Unidad 'Min'
  const unit = document.createElement('div');
  // 💡 UNIT_WIDTH aumentado a 70 para garantizar que "Min" quepa
  unit.innerHTML = ledSVG('Min', UNIT_WIDTH, dotH, fsBase, {clipWidth: UNIT_WIDTH-2, align:'left', isAlert});
  c3.appendChild(unit);
  
  r.appendChild(c3);

  return r;
}

function render(rows, totalH, destW, lineW_Col, etaW, dotH, fsBase){
  el.led.innerHTML='';
  const layoutRowH = Math.ceil(totalH / cfg.maxRows); 
  const UNIT_WIDTH = 70; /* CORREGIDO: Ahora es 70px para "Min" */
  const ETA_COLUMN_WIDTH = etaW; 

  if(!rows.length){
    const r = document.createElement('div'); r.className='row'; r.style.height = layoutRowH+'px';
    const c2 = document.createElement('div'); c2.className='col-dest';
    // German message
    const shortText = truncateHard('Keine weiteren Fahrten 🚌', Math.floor(fsBase*cfg.textBoost), destW-2);
    c2.innerHTML = ledSVG(shortText, destW, dotH, fsBase, {clipWidth: destW-2, align:'left'}); 
    r.appendChild(document.createElement('div')); r.appendChild(c2); r.appendChild(document.createElement('div'));
    el.led.appendChild(r);
    return;
  }

  for(const it of rows){
    const rowEl = createRow(it, dotH, fsBase, destW, lineW_Col, ETA_COLUMN_WIDTH, UNIT_WIDTH);
    rowEl.style.height = layoutRowH+'px';
    el.led.appendChild(rowEl);
  }
}

function renderMessage(message, isError=false) {
    el.led.innerHTML = '';
    const msgDiv = document.createElement('div');
    msgDiv.className = 'led-message';
    msgDiv.textContent = message;
    el.led.appendChild(msgDiv);
    
    el.age.classList.remove('loading');
    el.age.classList.toggle('error-state', isError);
    // Footer messages in German
    el.age.textContent = isError ? "FEHLER!" : "Lade Daten...";
}

// --- MAIN RUN FUNCTION (Español/Inglés) ---
async function run(){
  if (isLoading) return; 

  if (!cfg.stopQuery) {
    renderMessage("❌ FEHLER: Bitte 'stopQuery' Variable einstellen. ❌", true);
    return;
  }

  // Layout Calculations
  const totalH = el.led.clientHeight;
  const dotH = Math.floor(totalH / cfg.dotBaselineRows);
  const lineW_Col = 170; // Ancho de la columna Linea (Fijo)
  const etaW_Col  = 180; // CORREGIDO: Ahora es 180px para Abfahrt in
  
  // DestW takes the remaining space
  const destW = Math.floor(el.led.clientWidth - lineW_Col - etaW_Col - 2); 
  
  const etaW = etaW_Col;
  const fsBase = fitFontSizeHeightOnly(dotH, 0.78);
  
  let deps = loadCache();
  if (deps) {
    render(pickRows(deps), totalH, destW, lineW_Col, etaW, dotH, fsBase);
    const cachedStation = localStorage.getItem('stationName');
    if(cachedStation) el.station.textContent = cachedStation;
  } else {
    renderMessage("Lade Daten...", false);
  }

  isLoading = true;
  try{
    deps = await loadData();
    const rows = pickRows(deps || []);
    render(rows, totalH, destW, lineW_Col, etaW, dotH, fsBase);
    lastRefreshTs = Date.now();
    localStorage.setItem('stationName', el.station.textContent); 

  }catch(e){
    console.error("Critical error fetching data:", e);
    if (!deps) {
      renderMessage("❌ API/Netzwerkfehler ❌\nVerbindung prüfen.", true);
    }
  } finally {
    isLoading = false;
    tickAge(); 
  }
}

// --- INITIALIZATION (Español/Inglés) ---
window.addEventListener('resize', run); 
run(); 
setInterval(run, cfg.refreshMs); 
</script>
</body>
</html>
